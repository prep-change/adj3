<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>釣銭準備</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-xl mx-auto bg-white p-4 rounded shadow space-y-4">
    <h1 class="text-xl font-bold">釣銭準備</h1>

    <div>
      <p class="font-semibold">在庫を入力（枚数）:</p>
      <div id="inputs" class="grid grid-cols-3 gap-2 mt-2"></div>
    </div>

    <div>
      <p class="font-semibold">不足金種の調整候補から除外する金種:</p>
      <div id="excludeChecks" class="grid grid-cols-3 gap-2 mt-2 text-sm"></div>
    </div>

    <div class="flex space-x-2">
      <button onclick="calculate()" class="bg-blue-500 text-white px-4 py-2 rounded">計算する</button>
      <button onclick="adjust()" class="bg-green-500 text-white px-4 py-2 rounded">調整する</button>
    </div>

    <div id="result" class="whitespace-pre-wrap text-sm"></div>
  </div>

  <script>
    const denominations = [10000, 5000, 1000, 500, 100, 50, 10, 5, 1];
    const goalAmount = 155600;
    const goalCounts = {10000: 5, 5000: 4, 1000: 10, 500: 20, 100: 50, 50: 40, 10: 50, 5: 20, 1: 10};

    const inputsDiv = document.getElementById("inputs");
    const checksDiv = document.getElementById("excludeChecks");

    denominations.forEach(denom => {
      inputsDiv.innerHTML += `
        <label class="flex items-center space-x-1">
          <span>${denom}円</span>
          <input id="in_${denom}" type="number" min="0" value="0" class="w-16 border rounded px-1 py-0.5">
        </label>`;
      checksDiv.innerHTML += `
        <label class="flex items-center space-x-1">
          <input type="checkbox" id="chk_${denom}">
          <span>${denom}円</span>
        </label>`;
    });

    let shortage = {};

    function calculate() {
      shortage = {};
      let output = `目標金額: ${goalAmount.toLocaleString()}円\n\n`;
      let total = 0;

      denominations.forEach(d => {
        const stock = parseInt(document.getElementById(`in_${d}`).value || 0);
        const target = goalCounts[d];
        const count = Math.min(stock, target);
        const diff = target - count;

        if (diff > 0) {
          shortage[d] = diff;
        }

        total += d * count;
        output += `${d}円: 使う ${count}枚（目標 ${target} / 在庫 ${stock}）\n`;
      });

      output += `\n不足: ${Object.entries(shortage).map(([d,n]) => `${d}円 × ${n}`).join(', ') || 'なし'}\n`;
      output += `合計: ${total.toLocaleString()}円`;

      document.getElementById("result").textContent = output;
    }

    function adjust() {
      if (!shortage || Object.keys(shortage).length === 0) {
        document.getElementById("result").textContent += "\n\n不足はありません。";
        return;
      }

      let excludeSet = new Set();
      denominations.forEach(d => {
        if (document.getElementById(`chk_${d}`).checked) {
          excludeSet.add(parseInt(d));
        }
      });

      const stock = {};
      denominations.forEach(d => {
        stock[d] = parseInt(document.getElementById(`in_${d}`).value || 0);
      });

      const input = {...stock};
      let shortageCopy = {...shortage};

      // 調整: 除外されてない不足金種を1枚ずつ増やす
      for (const d of denominations) {
        if (shortageCopy[d] && !excludeSet.has(parseInt(d))) {
          shortageCopy[d] -= 1;
          input[d] += 1;
        }
      }

      // 不足の残り金額を補填
      let remain = 0;
      for (const [d, n] of Object.entries(shortageCopy)) {
        remain += parseInt(d) * n;
      }

      const fill = {};
      for (const d of denominations) {
        let maxUse = stock[d] - input[d];
        let need = Math.floor(remain / d);
        let use = Math.min(need, maxUse);
        if (use > 0) {
          fill[d] = use;
          input[d] += use;
          remain -= use * d;
        }
      }

      let output = `調整後:\n\n`;
      let total = 0;

      denominations.forEach(d => {
        const count = input[d];
        total += d * count;
        output += `${d}円: 使う ${count}枚\n`;
      });

      output += `\n補填内訳: ${Object.entries(fill).map(([d, n]) => `${d}円×${n}`).join(', ') || 'なし'}\n`;
      output += `合計: ${total.toLocaleString()}円`;

      document.getElementById("result").textContent = output;
    }
  </script>
</body>
</html>
