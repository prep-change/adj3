<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>釣銭準備</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div class="max-w-xl mx-auto p-4">
      <h1 class="text-2xl font-bold mb-4">釣銭準備</h1>
      <div class="mb-4">
        <label class="block font-semibold">在庫枚数を入力：</label>
        <div id="inputs" class="grid grid-cols-2 gap-2 mt-2"></div>
      </div>
      <div class="mb-4">
        <label class="block font-semibold">補填に使わない金種：</label>
        <div id="excludeOptions" class="flex flex-wrap gap-2 mt-2"></div>
      </div>
      <button id="calcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">計算する</button>
      <div id="result" class="mt-4"></div>
    </div>

    <script>
      const denominations = [5000, 1000, 500, 100, 50, 10, 5, 1];
      const baseTargets = { 5000: 15, 1000: 42, 500: 50, 100: 100, 50: 50, 10: 100, 5: 16, 1: 20 };

      const inputsDiv = document.getElementById("inputs");
      const excludeOptionsDiv = document.getElementById("excludeOptions");
      const resultDiv = document.getElementById("result");

      const inputElems = {};
      const excludeCheckboxes = {};

      denominations.forEach((denom) => {
        const label = document.createElement("label");
        label.textContent = `${denom}円`;
        const input = document.createElement("input");
        input.type = "number";
        input.value = 0;
        input.min = 0;
        input.className = "border rounded p-1 w-full";
        inputsDiv.appendChild(label);
        inputsDiv.appendChild(input);
        inputElems[denom] = input;

        const checkboxLabel = document.createElement("label");
        checkboxLabel.className = "inline-flex items-center";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "mr-1";
        excludeCheckboxes[denom] = checkbox;
        checkboxLabel.appendChild(checkbox);
        checkboxLabel.appendChild(document.createTextNode(`${denom}円`));
        excludeOptionsDiv.appendChild(checkboxLabel);
      });

      document.getElementById("calcBtn").addEventListener("click", () => {
        const stock = {};
        denominations.forEach((d) => (stock[d] = parseInt(inputElems[d].value, 10) || 0));

        const excludeList = denominations.filter((d) => excludeCheckboxes[d].checked);

        const result = adjustCoins(stock, baseTargets, excludeList);

        resultDiv.innerHTML = `
          <div class="font-semibold mb-2">不足枚数：</div>
          <ul class="list-disc list-inside mb-4">
            ${Object.entries(result.shortage)
              .map(([denom, count]) => `<li>${denom}円 × ${count}枚</li>`) 
              .join("") || "<li>なし</li>"}
          </ul>
          <div class="font-semibold mb-2">補填内訳：</div>
          <ul class="list-disc list-inside">
            ${result.substitutes
              .map((s) => `<li>${s.denom}円 × ${s.count}枚</li>`) 
              .join("") || "<li>なし</li>"}
          </ul>
        `;
      });

      function adjustCoins(stock, targets, exclude) {
        const shortage = {};
        const substitutes = [];
        const tempStock = { ...stock };

        for (const d of denominations) {
          const needed = targets[d];
          const available = tempStock[d];
          if (available < needed) {
            shortage[d] = needed - available;
            tempStock[d] = 0;
          } else {
            tempStock[d] -= needed;
          }
        }

        for (const [dStr, count] of Object.entries(shortage)) {
          const denom = parseInt(dStr);
          let remaining = denom * count;

          for (const sub of denominations) {
            if (sub === denom || exclude.includes(sub)) continue;
            const subCount = Math.floor(remaining / sub);
            const usable = Math.min(subCount, tempStock[sub]);
            if (usable > 0) {
              substitutes.push({ denom: sub, count: usable });
              tempStock[sub] -= usable;
              remaining -= usable * sub;
              if (remaining <= 0) break;
            }
          }
        }

        return { shortage, substitutes };
      }
    </script>
  </body>
</html>
